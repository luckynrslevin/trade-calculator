<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="description" content="A simple calculator to determine the position size of a stock trade. Calculate your position size in units based on defined portfolio value, risk, stock price and stop loss." />
    <meta name="theme-color" content="#4caf50" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Trade Calculator" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjNGNhZjUwIi8+Cjx0ZXh0IHg9Ijk2IiB5PSI5NiIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjQ4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+VEM8L3RleHQ+Cjwvc3ZnPg==" />
    <title>Trade Calculator</title>

    <style>
      /* General Styles */
      body {
        font-family: "Roboto", sans-serif;
        padding: 40px 20px;
        background-color: #f8f9fa;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      /* Form Styles */
      form {
        width: 400px; /* Fixed width for the form */
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      /* Centered Header within the Form Box */
      .form-title {
        text-align: center;
        font-size: 2rem;
        color: #333;
        margin-bottom: 30px;
        font-weight: bold;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 1rem;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin-bottom: 20px;
        font-size: 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      input:focus,
      select:focus {
        border-color: #4caf50;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        outline: none;
      }

      /* Result Box Styles */
      .result-box {
        width: 400px; /* Fixed width for result box */
        background-color: #fff;
        padding: 20px;
        margin-top: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      /* Error Message */
      .error {
        color: red;
        font-size: 1rem;
        text-align: center;
        margin-top: 10px;
        word-wrap: break-word; /* Line break for long error messages */
        white-space: normal; /* Prevents text from overflowing */
      }

      /* Results */
      #results,
      #sum {
        text-align: center;
        font-size: 1.2rem;
        color: #333;
        font-weight: 600;
        margin-top: 20px;
        word-wrap: break-word; /* Line break for long texts */
        white-space: normal; /* Prevents text from overflowing */
      }

      #results {
        color: #4caf50;
      }

      #sum {
        color: #555;
        font-weight: normal;
      }

      /* Hover Effects */
      input:hover,
      select:hover {
        border-color: #007bff;
      }

      /* Container for Layout */
      .container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 20px;
      }

      #reset-button {
        width: 100%;
        padding: 12px;
        background-color: #f44336; /* Red */
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #reset-button:hover {
        background-color: #d32f2f;
      }

      /* Mobile Responsive Styles */
      @media screen and (max-width: 768px) {
        body {
          padding: 20px 10px;
          height: auto;
          min-height: 100vh;
        }

        .container {
          padding: 10px;
        }

        form {
          width: 100%;
          max-width: none;
          margin: 0;
          padding: 20px;
        }

        .result-box {
          width: 100%;
          max-width: none;
          margin-top: 20px;
          padding: 20px;
        }

        .form-title {
          font-size: 1.5rem;
          margin-bottom: 20px;
        }

        input,
        select {
          padding: 15px;
          font-size: 1.1rem;
          margin-bottom: 15px;
        }

        label {
          font-size: 1rem;
          margin-bottom: 8px;
        }

        #reset-button {
          padding: 15px;
          font-size: 1.1rem;
          margin-top: 10px;
        }

        #result {
          font-size: 1.1rem;
        }

        #total-cost,
        #risk-amount {
          font-size: 1rem;
        }

        .error {
          font-size: 0.9rem;
        }
      }

      @media screen and (max-width: 480px) {
        body {
          padding: 15px 5px;
        }

        form {
          padding: 15px;
        }

        .result-box {
          padding: 15px;
        }

        .form-title {
          font-size: 1.3rem;
        }

        input,
        select {
          padding: 12px;
          font-size: 1rem;
        }

        #reset-button {
          padding: 12px;
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Input form Section -->
      <form id="calculation-form">
        <!-- Title inside the input box -->
        <div class="form-title">Trade Calculator</div>

        <label for="portfoliovalue">Portfolio value (€):</label>
        <input type="text" id="portfoliovalue" value="" required />

        <label for="risk">Portfolio risk (%):</label>
        <select id="risk" required>
          <option value="0.005">0,5%</option>
          <option value="0.01" selected>1,0%</option>
          <option value="0.02">2,0%</option>
        </select>

        <label for="price">Price (€):</label>
        <input type="text" id="price" required />

        <label for="stop">Stop (€):</label>
        <input type="text" id="stop" required />

        <button type="button" id="reset-button">Reset input form</button>
      </form>

      <!-- Result Box to display results -->
      <div class="result-box">
        <h2 id="result">Waiting for Calculation...</h2>
        <p id="total-cost"></p>
        <p id="risk-amount"></p>
        <p id="error-message" class="error"></p>
      </div>
    </div>

    <script>
      // Function to get URL parameters
      function getURLParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // State persistence functions for iOS background handling
      function saveFormState() {
        const state = {
          portfoliovalue: document.getElementById("portfoliovalue").value,
          risk: document.getElementById("risk").value,
          price: document.getElementById("price").value,
          stop: document.getElementById("stop").value,
          timestamp: Date.now()
        };
        localStorage.setItem('tradeCalculatorState', JSON.stringify(state));
      }

      function restoreFormState() {
        try {
          const savedState = localStorage.getItem('tradeCalculatorState');
          if (savedState) {
            const state = JSON.parse(savedState);
            // Only restore if saved within last 24 hours
            if (Date.now() - state.timestamp < 24 * 60 * 60 * 1000) {
              document.getElementById("portfoliovalue").value = state.portfoliovalue || "";
              document.getElementById("risk").value = state.risk || "0.01";
              document.getElementById("price").value = state.price || "";
              document.getElementById("stop").value = state.stop || "";
              return true;
            }
          }
        } catch (e) {
          console.log("Could not restore form state:", e);
        }
        return false;
      }

      function clearFormState() {
        localStorage.removeItem('tradeCalculatorState');
      }

      // Inject values into the form fields based on the URL parameters
      window.onload = function () {
        const portfoliovalueParam = getURLParam("portfoliovalue");
        const priceParam = getURLParam("price");
        const stopParam = getURLParam("stop");
        const riskParam = getURLParam("risk");

        // If URL parameters are provided, they take precedence
        if (portfoliovalueParam || priceParam || stopParam || riskParam) {
          if (portfoliovalueParam) {
            document.getElementById("portfoliovalue").value = portfoliovalueParam;
          }
          if (priceParam) {
            document.getElementById("price").value = priceParam;
          }
          if (stopParam) {
            document.getElementById("stop").value = stopParam;
          }
          if (riskParam) {
            document.getElementById("risk").value = riskParam;
          }
        } else {
          // Otherwise try to restore from localStorage
          restoreFormState();
        }
        
        // Call the calculation function after setting parameters
        calculate();

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }).catch(function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
        }
      };

      // Prevent form submission when hitting Enter
      document
        .getElementById("calculation-form")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent form submission
        });

      // Reset input form
      document
        .getElementById("reset-button")
        .addEventListener("click", function () {
          // Clear all inputs
          document.getElementById("portfoliovalue").value = "";
          document.getElementById("risk").value = "0.01"; // Default to 1% risk
          document.getElementById("price").value = "";
          document.getElementById("stop").value = "";

          // Reset the result section
          document.getElementById("result").innerText =
            "Waiting for Calculation...";
          document.getElementById("total-cost").innerText = "";
          document.getElementById("risk-amount").innerText = "";
          document.getElementById("error-message").innerText = "";

          // Clear saved state
          clearFormState();
        });

      function parseEuro(value) {
        return parseFloat(value.replace(/\./g, "").replace(",", "."));
      }

      function formatInput(event) {
        const input = event.target;
        const originalValue = input.value;
        const originalCursor = input.selectionStart;

        console.log("Original Input:", originalValue);

        // === STEP 1: Extract digits and comma only ===
        let cleanedValue = originalValue.replace(/[^\d,]/g, "");
        console.log("Cleaned input:", cleanedValue);

        // === STEP 2: Detect if comma was typed at the current cursor position ===
        const justTypedComma =
          originalValue[originalCursor - 1] === "," &&
          (originalCursor === originalValue.length ||
            /\d/.test(originalValue[originalCursor]));

        // === STEP 3: Remove leading zeros (before comma only) ===
        let [intPart, decPart] = cleanedValue.split(",");
        intPart = intPart.replace(/^0+/, "") || "";

        // === STEP 4: Limit decimal digits ===
        if (decPart) {
          decPart = decPart.substring(0, 2);
        }

        // === STEP 5: Count digits before cursor ===
        const digitsBeforeCursor = originalValue
          .substring(0, originalCursor)
          .replace(/[^\d]/g, "").length;

        // === STEP 6: Format integer part with dots ===
        let formattedInt = "";
        for (let i = intPart.length - 1, count = 1; i >= 0; i--, count++) {
          formattedInt = intPart[i] + formattedInt;
          if (count % 3 === 0 && i !== 0) {
            formattedInt = "." + formattedInt;
          }
        }

        // === STEP 7: Combine parts into final value ===
        const formattedValue =
          decPart !== undefined ? `${formattedInt},${decPart}` : formattedInt;
        input.value = formattedValue;

        // === STEP 8: Restore cursor position ===
        let newCursor = 0;
        let digitCount = 0;
        for (let i = 0; i < formattedValue.length; i++) {
          if (/\d/.test(formattedValue[i])) {
            digitCount++;
          }
          if (digitCount >= digitsBeforeCursor) {
            newCursor = i + 1;
            break;
          }
        }

        // Default to end if all digits are counted
        if (digitCount < digitsBeforeCursor) {
          newCursor = formattedValue.length;
        }

        // === STEP 9: Special handling if user just typed a comma ===
        if (justTypedComma && !formattedValue.includes(",,")) {
          newCursor = formattedValue.indexOf(",") + 1;
        }

        input.setSelectionRange(newCursor, newCursor);
      }

      // Function for Calculation
      function calculate() {
        // Reset error message and result
        document.getElementById("error-message").innerText = "";
        document.getElementById("result").innerText =
          "Waiting for Calculation...";
        document.getElementById("total-cost").innerText = "";
        document.getElementById("risk-amount").innerText = "";

        // Get values from input fields
        const portfolioValue = parseEuro(
          document.getElementById("portfoliovalue").value
        );
        const price = parseEuro(document.getElementById("price").value);
        const stop = parseEuro(document.getElementById("stop").value);
        const portfolioRiskPercentage = parseFloat(
          document.getElementById("risk").value
        );

        // Calculate risk
        const risk = portfolioValue * portfolioRiskPercentage;

        // Validations
        if (
          isNaN(portfolioValue) ||
          isNaN(portfolioRiskPercentage) ||
          isNaN(price) ||
          isNaN(stop)
        ) {
          document.getElementById("error-message").innerText =
            "Error: Please enter valid numbers!";
          return;
        }

        if (portfolioValue <= 0) {
          document.getElementById("error-message").innerText =
            "Error: Please enter the overall value of your trading portfolio!";
          return;
        }

        if (portfolioValue > 0 && (price <= 0 || stop <= 0)) {
          document.getElementById("error-message").innerText =
            "Error: Please enter positive number for price and stop!";
          return;
        }

        if (stop > price) {
          document.getElementById("error-message").innerText =
            "Error: The stop value cannot be greater than the price!";
          return;
        }

        if (price === stop) {
          document.getElementById("error-message").innerText =
            "Error: Price and stop cannot be the same!";
          return;
        }

        // Calculation
        if (price > stop) {
          const amount = risk / (price - stop);
          const totalCost = amount * price;

          // Format the results
          const amountFormatted = Math.round(amount).toLocaleString("de-DE");
          const totalCostFormatted = totalCost.toLocaleString("de-DE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
          const riskFormatted = risk.toLocaleString("de-DE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

          // Display results
          document.getElementById(
            "result"
          ).innerText = `The amount is: ${amountFormatted} units`;
          document.getElementById(
            "total-cost"
          ).innerText = `Total cost: ${totalCostFormatted} €`;
          document.getElementById(
            "risk-amount"
          ).innerText = `Risk amount: ${riskFormatted} €`;
        } else {
          document.getElementById("result").innerText =
            "The price must be greater than the stop!";
        }
      }

      // Attach event listeners to portfolio value, price, and stop fields
      document
        .getElementById("portfoliovalue")
        .addEventListener("input", function (event) {
          formatInput(event); // Format the input
          calculate(); // Perform calculation
          saveFormState(); // Save state for iOS background handling
        });

      document
        .getElementById("price")
        .addEventListener("input", function (event) {
          formatInput(event); // Format the input
          calculate(); // Perform calculation
          saveFormState(); // Save state for iOS background handling
        });

      document
        .getElementById("stop")
        .addEventListener("input", function (event) {
          formatInput(event); // Format the input
          calculate(); // Perform calculation
          saveFormState(); // Save state for iOS background handling
        });
      
      document
        .getElementById("risk")
        .addEventListener("change", function () {
          calculate();
          saveFormState(); // Save state for iOS background handling
        });

      // Additional event listeners for mobile/iOS state preservation
      window.addEventListener("beforeunload", saveFormState);
      window.addEventListener("pagehide", saveFormState);
      window.addEventListener("visibilitychange", function() {
        if (document.visibilityState === "hidden") {
          saveFormState();
        }
      });
    </script>
  </body>
</html>
