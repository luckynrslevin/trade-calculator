<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trade Calculator</title>

    <style>
      /* General Styles */
      body {
        font-family: "Roboto", sans-serif;
        padding: 40px 20px;
        background-color: #f8f9fa;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      /* Form Styles */
      form {
        width: 400px; /* Fixed width for the form */
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      /* Centered Header within the Form Box */
      .form-title {
        text-align: center;
        font-size: 2rem;
        color: #333;
        margin-bottom: 30px;
        font-weight: bold;
      }

      label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        font-size: 1rem;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin-bottom: 20px;
        font-size: 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      input:focus,
      select:focus {
        border-color: #4caf50;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        outline: none;
      }

      /* Result Box Styles */
      .result-box {
        width: 400px; /* Fixed width for result box */
        background-color: #fff;
        padding: 20px;
        margin-top: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        box-sizing: border-box;
      }

      /* Error Message */
      .error {
        color: red;
        font-size: 1rem;
        text-align: center;
        margin-top: 10px;
        word-wrap: break-word; /* Line break for long error messages */
        white-space: normal; /* Prevents text from overflowing */
      }

      /* Results */
      #results,
      #sum {
        text-align: center;
        font-size: 1.2rem;
        color: #333;
        font-weight: 600;
        margin-top: 20px;
        word-wrap: break-word; /* Line break for long texts */
        white-space: normal; /* Prevents text from overflowing */
      }

      #results {
        color: #4caf50;
      }

      #sum {
        color: #555;
        font-weight: normal;
      }

      /* Hover Effects */
      input:hover,
      select:hover {
        border-color: #007bff;
      }

      /* Container for Layout */
      .container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        padding: 20px;
      }

      #reset-button {
        width: 100%;
        padding: 12px;
        background-color: #f44336; /* Red */
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #reset-button:hover {
        background-color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Input form Section -->
      <form id="calculation-form">
        <!-- Title inside the input box -->
        <div class="form-title">Trade Calculator</div>

        <label for="portfoliovalue">Portfolio value (€):</label>
        <input type="text" id="portfoliovalue" value="" required />

        <label for="risk">Portfolio risk (%):</label>
        <select id="risk" required>
          <option value="0.005">0,5%</option>
          <option value="0.01" selected>1,0%</option>
          <option value="0.02">2,0%</option>
        </select>

        <label for="price">Price (€):</label>
        <input type="text" id="price" required />

        <label for="stop">Stop (€):</label>
        <input type="text" id="stop" required />

        <button type="button" id="reset-button">Reset input form</button>
      </form>

      <!-- Result Box to display results -->
      <div class="result-box">
        <h2 id="result">Waiting for Calculation...</h2>
        <p id="total-cost"></p>
        <p id="risk-amount"></p>
        <p id="error-message" class="error"></p>
      </div>
    </div>

    <script>
      // Function to get URL parameters
      function getURLParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Inject values into the form fields based on the URL parameters
      window.onload = function () {
        const priceParam = getURLParam("price");
        const stopParam = getURLParam("stop");
        const riskParam = getURLParam("risk");

        if (priceParam) {
          document.getElementById("price").value = priceParam;
        }
        if (stopParam) {
          document.getElementById("stop").value = stopParam;
        }
        if (riskParam) {
          document.getElementById("risk").value = riskParam;
        }
        // Call the calculation function after setting parameters
        calculate();
      };

      // Prevent form submission when hitting Enter
      document
        .getElementById("calculation-form")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // Prevent form submission
        });

      // Reset input form
      document
        .getElementById("reset-button")
        .addEventListener("click", function () {
          // Clear all inputs
          document.getElementById("portfoliovalue").value = "";
          document.getElementById("risk").value = "0.01"; // Default to 1% risk
          document.getElementById("price").value = "";
          document.getElementById("stop").value = "";

          // Reset the result section
          document.getElementById("result").innerText =
            "Waiting for Calculation...";
          document.getElementById("total-cost").innerText = "";
          document.getElementById("risk-amount").innerText = "";
          document.getElementById("error-message").innerText = "";
        });

      // Function to format input fields with european currency format
      // function formatInput(event) {
      //   let inputValue = event.target.value;
      //   console.log("Original Input:", inputValue); // Log the input as the user types it.

      //   // save cursor position
      //   const cursorPosition = inputValue.selectionStart;

      //   // Remove all characters except digits, commas, and dots
      //   inputValue = inputValue.replace(/[^\d,\.]/g, "");
      //   console.log("After removing non-numeric characters:", inputValue);

      //   // Remove leading zeros
      //   inputValue = inputValue.replace(/^0+/, "");
      //   console.log("After removing leading zeros:", inputValue);

      //   // Remove trailing dots
      //   inputValue = inputValue.replace(/\.$/, "");
      //   console.log("After removing trailing dots:", inputValue);

      //   // If input contains more than one comma, remove the second comma
      //   const commaCount = (inputValue.match(/,/g) || []).length;
      //   console.log("Number of commas in input:", commaCount);

      //   if (commaCount > 1) {
      //     // Remove second comma by splitting, taking the first part and removing any additional commas
      //     let parts = inputValue.split(",");
      //     if (parts.length > 2) {
      //       // Remove any extra commas after the first one
      //       inputValue =
      //         parts[0] + "," + parts.slice(1).join("").replace(/,/g, "");
      //     }
      //     console.log("After removing the second comma:", inputValue);
      //   }

      //   // Split integer part and decimal part
      //   let [integerPart, decimalPart] = inputValue.split(",");
      //   if (decimalPart) {
      //     decimalPart = decimalPart.substring(0, 2); // Keep only the first 2 digits
      //   }
      //   console.log("Integer part before formatting:", integerPart);
      //   console.log("Decimal part before formatting:", decimalPart);

      //   // Add thousands separator for the integer part
      //   if (integerPart) {
      //     integerPart = integerPart.replace(/\./g, ""); // Remove existing dots
      //     console.log(
      //       "Integer part after removing existing dots:",
      //       integerPart
      //     );
      //     integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      //   }
      //   console.log("Integer part with thousands separator:", integerPart);

      //   // Rebuild the overall formatted value
      //   console.log("CommaCount:", commaCount);
      //   if (commaCount > 0) {
      //     if (decimalPart) {
      //       inputValue = `${integerPart},${decimalPart}`;
      //     } else {
      //       inputValue = `${integerPart},`;
      //     }
      //   } else {
      //     inputValue = `${integerPart}`;
      //   }
      //   console.log("Final formatted input:", inputValue);

      //   // Update the input field with the formatted value
      //   event.target.value = inputValue;
      // }

      function parseEuro(value) {
        return parseFloat(value.replace(/\./g, "").replace(",", "."));
      }

      function formatInput(event) {
        const input = event.target;
        const originalValue = input.value;
        const originalCursor = input.selectionStart;

        console.log("Original Input:", originalValue);

        // === STEP 1: Extract digits and comma only ===
        let cleanedValue = originalValue.replace(/[^\d,]/g, "");
        console.log("Cleaned input:", cleanedValue);

        // === STEP 2: Detect if comma was typed at the current cursor position ===
        const justTypedComma =
          originalValue[originalCursor - 1] === "," &&
          (originalCursor === originalValue.length ||
            /\d/.test(originalValue[originalCursor]));

        // === STEP 3: Remove leading zeros (before comma only) ===
        let [intPart, decPart] = cleanedValue.split(",");
        intPart = intPart.replace(/^0+/, "") || "0";

        // === STEP 4: Limit decimal digits ===
        if (decPart) {
          decPart = decPart.substring(0, 2);
        }

        // === STEP 5: Count digits before cursor ===
        const digitsBeforeCursor = originalValue
          .substring(0, originalCursor)
          .replace(/[^\d]/g, "").length;

        // === STEP 6: Format integer part with dots ===
        let formattedInt = "";
        for (let i = intPart.length - 1, count = 1; i >= 0; i--, count++) {
          formattedInt = intPart[i] + formattedInt;
          if (count % 3 === 0 && i !== 0) {
            formattedInt = "." + formattedInt;
          }
        }

        // === STEP 7: Combine parts into final value ===
        const formattedValue =
          decPart !== undefined ? `${formattedInt},${decPart}` : formattedInt;
        input.value = formattedValue;

        // === STEP 8: Restore cursor position ===
        let newCursor = 0;
        let digitCount = 0;
        for (let i = 0; i < formattedValue.length; i++) {
          if (/\d/.test(formattedValue[i])) {
            digitCount++;
          }
          if (digitCount >= digitsBeforeCursor) {
            newCursor = i + 1;
            break;
          }
        }

        // Default to end if all digits are counted
        if (digitCount < digitsBeforeCursor) {
          newCursor = formattedValue.length;
        }

        // === STEP 9: Special handling if user just typed a comma ===
        if (justTypedComma && !formattedValue.includes(",,")) {
          newCursor = formattedValue.indexOf(",") + 1;
        }

        input.setSelectionRange(newCursor, newCursor);
      }

      // Function for Calculation
      function calculate() {
        // Reset error message and result
        document.getElementById("error-message").innerText = "";
        document.getElementById("result").innerText =
          "Waiting for Calculation...";
        document.getElementById("total-cost").innerText = "";
        document.getElementById("risk-amount").innerText = "";

        // Get values from input fields
        const portfolioValue = parseEuro(
          document.getElementById("portfoliovalue").value
        );
        const price = parseEuro(document.getElementById("price").value);
        const stop = parseEuro(document.getElementById("stop").value);
        const portfolioRiskPercentage = parseFloat(
          document.getElementById("risk").value
        );

        // Calculate risk
        const risk = portfolioValue * portfolioRiskPercentage;

        // Validations
        if (
          isNaN(portfolioValue) ||
          isNaN(portfolioRiskPercentage) ||
          isNaN(price) ||
          isNaN(stop)
        ) {
          document.getElementById("error-message").innerText =
            "Error: Please enter valid numbers!";
          return;
        }

        if (portfolioValue <= 0) {
          document.getElementById("error-message").innerText =
            "Error: Please enter the overall value of your trading portfolio!";
          return;
        }

        if (portfolioValue > 0 && (price <= 0 || stop <= 0)) {
          document.getElementById("error-message").innerText =
            "Error: Please enter positive number for price and stop!";
          return;
        }

        if (stop > price) {
          document.getElementById("error-message").innerText =
            "Error: The stop value cannot be greater than the price!";
          return;
        }

        if (price === stop) {
          document.getElementById("error-message").innerText =
            "Error: Price and stop cannot be the same!";
          return;
        }

        // Calculation
        if (price > stop) {
          const amount = risk / (price - stop);
          const totalCost = amount * price;

          // Format the results
          const amountFormatted = Math.round(amount).toLocaleString("de-DE");
          const totalCostFormatted = totalCost.toLocaleString("de-DE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
          const riskFormatted = risk.toLocaleString("de-DE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

          // Display results
          document.getElementById(
            "result"
          ).innerText = `The amount is: ${amountFormatted} units`;
          document.getElementById(
            "total-cost"
          ).innerText = `Total cost: ${totalCostFormatted} €`;
          document.getElementById(
            "risk-amount"
          ).innerText = `Risk amount: ${riskFormatted} €`;
        } else {
          document.getElementById("result").innerText =
            "The price must be greater than the stop!";
        }
      }

      // Attach event listeners to portfolio value, price, and stop fields
      document
        .getElementById("portfoliovalue")
        .addEventListener("input", function (event) {
          formatInput(event); // Format the input
          calculate(); // Perform calculation
        });

      document
        .getElementById("price")
        .addEventListener("input", function (event) {
          formatInput(event); // Format the input
          calculate(); // Perform calculation
        });

      document
        .getElementById("stop")
        .addEventListener("input", function (event) {
          formatInput(event); // Format the input
          calculate(); // Perform calculation
        });
    </script>
  </body>
</html>
